# 文書画像セグメンテーションアプリケーション

Detectron2で学習されたMask R-CNNモデル（model.onnx）を使用して、文書画像から文字列を抽出・セグメンテーションするGUIアプリケーションです。

## 機能

### 1. ファイル読み込み
- **対応形式**: PDF、PNG、JPG、JPEG
- **操作**: 「ファイルを開く」ボタンからファイルを選択
- **表示**: 選択したファイルがUI上に表示される

### 2. PDFページ操作
- **ページ切り替え**: 「前」「次」ボタンでページを切り替え
- **ページ表示**: 現在のページ数と総ページ数を表示

### 3. 表示制御
- **拡大率**: スライダーで0.1倍～3.0倍まで調整可能
- **表示位置**: X、Y位置スライダーで表示位置を調整
- **スクロール**: マウスホイールやスクロールバーで画像を移動

### 4. 前処理機能
- **二値化**: チェックボックスで有効/無効、閾値スライダーで調整（0-255）
- **回転**: スライダーで-180度～+180度まで回転可能
- **歪み補正**: チェックボックスで簡易的な歪み補正を適用

### 5. 文字認識
- **認識実行**: 「認識実行」ボタンでONNXモデルによる文字領域検出
- **結果表示**: 検出されたバウンディングボックスが画像上に表示

### 6. バウンディングボックス操作
- **一括サイズ調整**: スライダーで全てのバウンディングボックスを一括拡大・縮小
- **個別編集**: マウスで各バウンディングボックスを個別に操作
  - クリックで選択（赤色で表示）
  - 辺をドラッグしてサイズ変更
  - 中央をドラッグして移動
  - 角の操作ポイントが表示される

## 使用方法

### 1. 環境構築
```bash
# uvでプロジェクトを初期化（既に完了）
uv init

# 依存関係のインストール（既に完了）
uv add opencv-python onnxruntime pillow numpy PyMuPDF matplotlib
```

### 2. アプリケーション起動
```bash
uv run python main.py
```

### 3. 基本操作手順
1. **ファイル選択**: 「ファイルを開く」ボタンから画像またはPDFを選択
2. **表示調整**: 拡大率や位置スライダーで見やすく調整
3. **前処理**: 必要に応じて二値化、回転、歪み補正を適用
4. **認識実行**: 「認識実行」ボタンで文字領域を検出
5. **結果調整**: バウンディングボックスのサイズや位置を調整

## ファイル構成

```
line_segmentation_app/
├── main.py          # メインアプリケーション
├── model.onnx       # Detectron2 Mask R-CNNモデル
├── pyproject.toml   # プロジェクト設定
└── README.md        # このファイル
```

## モデルについて

- **形式**: ONNX
- **ベース**: Detectron2 Mask R-CNN
- **用途**: 文書画像からの文字列抽出
- **入力**: 画像データ（640x640にリサイズされます）
- **出力**: バウンディングボックス座標のリスト（出力インデックス0番目）

## カスタマイズ

### モデルの出力形式調整
モデルの出力形式に応じて、`run_recognition()`メソッド内の出力処理部分を調整してください：

```python
# 出力の最初の要素がバウンディングボックスと仮定
predictions = outputs[0]

# 出力形式に応じて調整が必要
if len(predictions.shape) >= 2:
    for detection in predictions[0]:  # バッチの最初を取得
        if len(detection) >= 4:
            # 座標を元の画像サイズに戻す
            x1 = int(detection[0] / scale_x)
            y1 = int(detection[1] / scale_y)
            x2 = int(detection[2] / scale_x)
            y2 = int(detection[3] / scale_y)
            
            # 信頼度チェック（信頼度が含まれている場合）
            confidence = detection[4] if len(detection) > 4 else 1.0
            if confidence > 0.5:  # 閾値
                self.bounding_boxes.append([x1, y1, x2, y2])
```

### 前処理の拡張
より高度な前処理を追加する場合は、`apply_preprocessing()`メソッドを拡張してください。

## 注意事項

- model.onnxファイルが同じディレクトリに存在する必要があります
- モデルの出力形式によっては、認識結果の処理部分の調整が必要です
- 大きなPDFファイルの場合、メモリ使用量にご注意ください
- バウンディングボックスの操作は、拡大表示時により精密に行えます

## トラブルシューティング

### モデル読み込みエラー
- model.onnxファイルの存在を確認
- ファイルが破損していないか確認
- ONNXランタイムのバージョンが適合しているか確認

### 認識結果が表示されない
- モデルの出力形式を確認
- 信頼度閾値を調整
- 前処理パラメータを調整

### 表示が崩れる
- 拡大率を調整
- 表示位置を初期化（スライダーを中央に戻す）
- アプリケーションを再起動
